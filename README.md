# Modbus TCP Slave Simulator

ä¸€å€‹åŠŸèƒ½å®Œæ•´çš„ Modbus TCP Slave æ¨¡æ“¬å™¨ï¼Œä½¿ç”¨ Go èªè¨€ç·¨å¯«ï¼Œæ”¯æ´å¤šå€‹ Slave å¯¦ä¾‹ã€å®Œæ•´çš„ Modbus åŠŸèƒ½ç¢¼ï¼Œä»¥åŠ Web ç›£æ§ç•Œé¢ã€‚

## ğŸš€ ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **å®Œæ•´çš„ Modbus TCP å”è­°æ”¯æ´**
- âœ… **æ”¯æ´æ‰€æœ‰ä¸»è¦åŠŸèƒ½ç¢¼** (0x01-0x06, 0x0F, 0x10)
- âœ… **å¤š Slave å¯¦ä¾‹ç®¡ç†** (å¯åŒæ™‚é‹è¡Œæ•¸åƒå€‹ Slaves)
- âœ… **Web ç›£æ§ç•Œé¢** (å¯¦æ™‚æ•¸æ“šæŸ¥çœ‹)
- âœ… **è‡ªå‹•æ•¸æ“šæ¨¡æ“¬** (æ¨¡æ“¬çœŸå¯¦æ„Ÿæ¸¬å™¨æ•¸æ“šè®ŠåŒ–)
- âœ… **ç·šç¨‹å®‰å…¨** (æ”¯æ´å¤šå®¢æˆ¶ç«¯åŒæ™‚é€£æ¥)
- âœ… **å„ªé›…é—œé–‰** (Ctrl+C å®‰å…¨åœæ­¢)

### æ”¯æ´çš„ Modbus åŠŸèƒ½ç¢¼

| åŠŸèƒ½ç¢¼ | åŠŸèƒ½ | æ•¸æ“šé¡å‹ | æ“ä½œ |
|--------|------|----------|------|
| 0x01 | Read Coils | ç·šåœˆ (Coils) | è®€å– |
| 0x02 | Read Discrete Inputs | é›¢æ•£è¼¸å…¥ (Discrete Inputs) | è®€å– |
| 0x03 | Read Holding Registers | ä¿æŒå¯„å­˜å™¨ (Holding Registers) | è®€å– |
| 0x04 | Read Input Registers | è¼¸å…¥å¯„å­˜å™¨ (Input Registers) | è®€å– |
| 0x05 | Write Single Coil | ç·šåœˆ (Coils) | å¯«å…¥å–®å€‹ |
| 0x06 | Write Single Register | ä¿æŒå¯„å­˜å™¨ (Holding Registers) | å¯«å…¥å–®å€‹ |
| 0x0F | Write Multiple Coils | ç·šåœˆ (Coils) | å¯«å…¥å¤šå€‹ |
| 0x10 | Write Multiple Registers | ä¿æŒå¯„å­˜å™¨ (Holding Registers) | å¯«å…¥å¤šå€‹ |

### æ•¸æ“šç¯„åœ
æ¯å€‹ Slave åŒ…å«ï¼š
- **ç·šåœˆ (Coils)**: 10,000 å€‹ (åœ°å€ 0-9999)
- **é›¢æ•£è¼¸å…¥ (Discrete Inputs)**: 10,000 å€‹ (åœ°å€ 0-9999)
- **ä¿æŒå¯„å­˜å™¨ (Holding Registers)**: 10,000 å€‹ (åœ°å€ 0-9999)
- **è¼¸å…¥å¯„å­˜å™¨ (Input Registers)**: 10,000 å€‹ (åœ°å€ 0-9999)

### ç¶²é é è¦½

<img width="1210" height="564" alt="Screenshot 2025-07-21 at 11 50 19" src="https://github.com/user-attachments/assets/1845af32-fa01-4e32-a3e7-8e29c34b22d6" />
<img width="1011" height="523" alt="Screenshot 2025-07-21 at 11 51 50" src="https://github.com/user-attachments/assets/736d10dc-7967-4750-82e1-aba89f10076b" />


## ğŸ“¦ å®‰è£èˆ‡ç·¨è­¯

### ç³»çµ±éœ€æ±‚
- Go 1.18 æˆ–æ›´é«˜ç‰ˆæœ¬
- Linux/Windows/macOS

### ç·¨è­¯
```bash
# å…‹éš†æˆ–ä¸‹è¼‰ä»£ç¢¼
git clone <repository-url>
cd modbus-tcp-slave

# ç·¨è­¯
go build -o modbus_slave main.go

# æˆ–ç›´æ¥é‹è¡Œ
go run main.go <èµ·å§‹ç«¯å£> <slavesæ•¸é‡>
```

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬èªæ³•
```bash
./modbus_slave <èµ·å§‹ç«¯å£> <slavesæ•¸é‡>
```

### ä½¿ç”¨ç¯„ä¾‹

#### 1. å•Ÿå‹•å–®å€‹ Slave
```bash
./modbus_slave 502 1
```
- ç«¯å£ï¼š502
- Slave IDï¼š1
- Web ç•Œé¢ï¼šhttp://localhost:8080

#### 2. å•Ÿå‹•å¤šå€‹ Slaves
```bash
./modbus_slave 10000 10
```
- ç«¯å£ç¯„åœï¼š10000-10009
- æ¯å€‹ç«¯å£éƒ½æ˜¯ Slave ID 1
- Web ç•Œé¢ï¼šhttp://localhost:8080

#### 3. å¤§è¦æ¨¡æ¸¬è©¦
```bash
./modbus_slave 5000 100
```
- 100 å€‹ Slavesï¼Œç«¯å£ 5000-5099
- é©åˆå£“åŠ›æ¸¬è©¦

## ğŸ”§ æ¸¬è©¦èˆ‡é©—è­‰

### ä½¿ç”¨ mbpoll å·¥å…·æ¸¬è©¦

#### å®‰è£ mbpoll
```bash
# Ubuntu/Debian
sudo apt-get install mbpoll

# CentOS/RHEL
sudo yum install mbpoll

# macOS
brew install mbpoll
```

#### æ¸¬è©¦å‘½ä»¤ç¯„ä¾‹

```bash
# å‡è¨­ Slave åœ¨ç«¯å£ 10000ï¼ŒSlave ID ç‚º 1

# 1. è®€å–ç·šåœˆ (åœ°å€ 0-19)
mbpoll -a 1 -r 0 -c 20 -t 0 -p 10000 -1 127.0.0.1

# 2. è®€å–é›¢æ•£è¼¸å…¥ (åœ°å€ 0-19)
mbpoll -a 1 -r 0 -c 20 -t 1 -p 10000 -1 127.0.0.1

# 3. è®€å–è¼¸å…¥å¯„å­˜å™¨ (åœ°å€ 0-19)
mbpoll -a 1 -r 0 -c 20 -t 3 -p 10000 -1 127.0.0.1

# 4. è®€å–ä¿æŒå¯„å­˜å™¨ (åœ°å€ 0-19)
mbpoll -a 1 -r 0 -c 20 -t 4 -p 10000 -1 127.0.0.1

# 5. å¯«å…¥å–®å€‹ç·šåœˆ (åœ°å€ 10ï¼Œå€¼ ON)
mbpoll -a 1 -r 10 -t 0 127.0.0.1 -p 10000 1

# 6. å¯«å…¥å–®å€‹å¯„å­˜å™¨ (åœ°å€ 10ï¼Œå€¼ 1234)
mbpoll -a 1 -r 10 -t 4 127.0.0.1 -p 10000 1234

# 7. è®€å–å¤§ç¯„åœæ•¸æ“š (åœ°å€ 0-99)
mbpoll -a 1 -r 0 -c 100 -t 4 -p 10000 -1 127.0.0.1
```

#### mbpoll åƒæ•¸èªªæ˜
- `-a`: Slave ID / Unit ID
- `-r`: èµ·å§‹åœ°å€
- `-c`: è®€å–æ•¸é‡
- `-t`: åŠŸèƒ½ç¢¼é¡å‹ (0=ç·šåœˆ, 1=é›¢æ•£è¼¸å…¥, 3=è¼¸å…¥å¯„å­˜å™¨, 4=ä¿æŒå¯„å­˜å™¨)
- `-p`: TCP ç«¯å£
- `-1`: å–®æ¬¡è®€å–
- `127.0.0.1`: IP åœ°å€

## ğŸŒ Web ç›£æ§ç•Œé¢

### è¨ªå•æ–¹å¼
ç¨‹å¼å•Ÿå‹•å¾Œï¼Œåœ¨ç€è¦½å™¨ä¸­æ‰“é–‹ï¼š**http://localhost:8080**

### åŠŸèƒ½ç‰¹è‰²
- ğŸ“Š **å¯¦æ™‚æ•¸æ“šé¡¯ç¤º**ï¼šæ‰€æœ‰ Slaves çš„ç•¶å‰ç‹€æ…‹
- ğŸ”„ **è‡ªå‹•æ›´æ–°**ï¼šæ¯ 5 ç§’è‡ªå‹•åˆ·æ–°æ•¸æ“š
- ğŸ›ï¸ **äº’å‹•å¼æ“ä½œ**ï¼šé»æ“ŠæŒ‰éˆ•æŸ¥çœ‹ä¸åŒé¡å‹çš„æ•¸æ“š
- ğŸ“ˆ **è¦–è¦ºåŒ–å±•ç¤º**ï¼šå½©è‰²åˆ†é¡é¡¯ç¤ºä¸åŒæ•¸æ“šé¡å‹
  - ğŸ”µ ç·šåœˆ (è—è‰²)
  - ğŸŸ£ é›¢æ•£è¼¸å…¥ (ç´«è‰²)
  - ğŸŸ¢ ä¿æŒå¯„å­˜å™¨ (ç¶ è‰²)
  - ğŸŸ  è¼¸å…¥å¯„å­˜å™¨ (æ©™è‰²)

### ç•Œé¢åŠŸèƒ½
- æŸ¥çœ‹æ¯å€‹ Slave çš„é‹è¡Œç‹€æ…‹
- å¯¦æ™‚ç›£æ§æ•¸æ“šè®ŠåŒ–
- æŸ¥çœ‹æŒ‡å®šç¯„åœçš„æ•¸æ“šå€¼
- æ”¯æ´æ‰€æœ‰æ•¸æ“šé¡å‹çš„æŸ¥çœ‹

## ğŸ“Š æ•¸æ“šæ¨¡æ“¬

### è‡ªå‹•æ•¸æ“šæ›´æ–°
ç¨‹å¼æœƒè‡ªå‹•æ¨¡æ“¬çœŸå¯¦è¨­å‚™çš„æ•¸æ“šè®ŠåŒ–ï¼š

#### è¼¸å…¥å¯„å­˜å™¨
- æ¯ 5-10 ç§’æ›´æ–°ä¸€æ¬¡ (æ ¹æ“š Slave ID èª¿æ•´é€±æœŸ)
- æ¨¡æ“¬æ„Ÿæ¸¬å™¨æ•¸æ“š (æº«åº¦ã€å£“åŠ›ç­‰)
- åŸºæ–¼æ™‚é–“æˆ³ç”Ÿæˆå‹•æ…‹å€¼

#### é›¢æ•£è¼¸å…¥
- æ¯ 5-10 ç§’æ›´æ–°ä¸€æ¬¡
- æ¨¡æ“¬é–‹é—œç‹€æ…‹ã€æ•¸ä½è¨Šè™Ÿ
- åŸºæ–¼æ™‚é–“å’Œ Slave ID ç”Ÿæˆæ¨¡å¼

#### éœæ…‹æ•¸æ“š
- **ç·šåœˆ**ï¼šå¯é€šé Modbus å¯«å…¥å‘½ä»¤ä¿®æ”¹
- **ä¿æŒå¯„å­˜å™¨**ï¼šå¯é€šé Modbus å¯«å…¥å‘½ä»¤ä¿®æ”¹

## ğŸ”’ å®‰å…¨èˆ‡ç©©å®šæ€§

### ç·šç¨‹å®‰å…¨
- æ‰€æœ‰æ•¸æ“šæ“ä½œéƒ½æœ‰ `sync.RWMutex` ä¿è­·
- æ”¯æ´å¤šå®¢æˆ¶ç«¯åŒæ™‚è®€å¯«
- ç„¡æ•¸æ“šç«¶çˆ­å•é¡Œ

### éŒ¯èª¤è™•ç†
- å®Œæ•´çš„ Modbus ç•°å¸¸å›æ‡‰
- ç¶²è·¯é€£æ¥ç•°å¸¸è™•ç†
- å„ªé›…çš„éŒ¯èª¤æ¢å¾©æ©Ÿåˆ¶

### è³‡æºç®¡ç†
- é€£æ¥è¶…æ™‚æ©Ÿåˆ¶ (30 ç§’)
- è‡ªå‹•æ¸…ç†ç„¡æ•ˆé€£æ¥
- è¨˜æ†¶é«”ä½¿ç”¨å„ªåŒ–

## ğŸš¦ ç‹€æ…‹ç›£æ§

### æ—¥èªŒè¼¸å‡º
ç¨‹å¼æä¾›è±å¯Œçš„æ—¥èªŒä¿¡æ¯ï¼š
```
ğŸš€ Modbus Slave 1 started on port 10000
ğŸ“– Slave 1: è®€å–ä¿æŒå¯„å­˜å™¨ 0-9, æ•¸é‡: 10
âœï¸ Slave 1: å¯«å…¥ç·šåœˆ 10: false -> true
ğŸ”„ Slave 1: æ¨¡æ“¬æ•¸æ“šå·²æ›´æ–°
```

### æ—¥èªŒé¡å‹
- ğŸš€ å•Ÿå‹•ä¿¡æ¯
- ğŸ”— é€£æ¥ç‹€æ…‹
- ğŸ“– è®€å–æ“ä½œ
- âœï¸ å¯«å…¥æ“ä½œ
- ğŸ”„ æ•¸æ“šæ›´æ–°
- âš ï¸ ç•°å¸¸è™•ç†
- ğŸ›‘ åœæ­¢ä¿¡æ¯

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

#### 1. ç«¯å£è¢«å ç”¨
```bash
Error: listen tcp :502: bind: address already in use
```
**è§£æ±ºæ–¹æ¡ˆ**ï¼šä½¿ç”¨å…¶ä»–ç«¯å£æˆ–åœæ­¢å ç”¨ç«¯å£çš„ç¨‹å¼

#### 2. æ¬Šé™ä¸è¶³ (ç«¯å£ < 1024)
```bash
Error: listen tcp :502: bind: permission denied
```
**è§£æ±ºæ–¹æ¡ˆ**ï¼šä½¿ç”¨ sudo æˆ–é¸æ“‡ > 1024 çš„ç«¯å£

#### 3. mbpoll é€£æ¥è¶…æ™‚
```bash
mbpoll: Operation timed out
```
**æª¢æŸ¥äº‹é …**ï¼š
- Slave æ˜¯å¦æ­£åœ¨é‹è¡Œ
- ç«¯å£è™Ÿæ˜¯å¦æ­£ç¢º
- Slave ID æ˜¯å¦åŒ¹é…
- é˜²ç«ç‰†è¨­ç½®

#### 4. æ•¸æ“šä¸åŒ¹é…
**æª¢æŸ¥äº‹é …**ï¼š
- ç¢ºèª Slave IDï¼šæ‰€æœ‰ç«¯å£éƒ½ä½¿ç”¨ Slave ID 1
- æª¢æŸ¥åŠŸèƒ½ç¢¼é¡å‹ (`-t` åƒæ•¸)
- ç¢ºèªåœ°å€ç¯„åœ (`-r` å’Œ `-c` åƒæ•¸)

### èª¿è©¦æŠ€å·§
1. **æŸ¥çœ‹æ—¥èªŒ**ï¼šç¨‹å¼æœƒè¼¸å‡ºè©³ç´°çš„æ“ä½œæ—¥èªŒ
2. **ä½¿ç”¨ Web ç•Œé¢**ï¼šå¯¦æ™‚æŸ¥çœ‹æ•¸æ“šç‹€æ…‹
3. **åˆ†æ­¥æ¸¬è©¦**ï¼šå…ˆæ¸¬è©¦ç°¡å–®çš„è®€å–æ“ä½œ
4. **æª¢æŸ¥ç¶²è·¯**ï¼šç¢ºä¿æœ¬åœ°ç¶²è·¯æš¢é€š

## ğŸ“‹ é–‹ç™¼èˆ‡æ“´å±•

### ä»£ç¢¼çµæ§‹
```
main.go
â”œâ”€â”€ ModbusSlave çµæ§‹é«”      # å–®å€‹ Slave å¯¦ä¾‹
â”œâ”€â”€ SlaveManager çµæ§‹é«”     # å¤š Slave ç®¡ç†å™¨
â”œâ”€â”€ Modbus åŠŸèƒ½ç¢¼è™•ç†       # å”è­°å¯¦ç¾
â”œâ”€â”€ Web æœå‹™å™¨             # ç›£æ§ç•Œé¢
â””â”€â”€ ä¸»ç¨‹å¼é‚è¼¯             # å•Ÿå‹•å’Œä¿¡è™Ÿè™•ç†
```

### è‡ªå®šç¾©ä¿®æ”¹
1. **ä¿®æ”¹æ•¸æ“šç¯„åœ**ï¼šèª¿æ•´ `make([]bool, 10000)` ä¸­çš„å¤§å°
2. **èª¿æ•´æ›´æ–°é »ç‡**ï¼šä¿®æ”¹ `simulateInputChanges()` ä¸­çš„ ticker
3. **æ›´æ”¹ Slave ID åˆ†é…**ï¼šä¿®æ”¹ `CreateSlaves()` ä¸­çš„é‚è¼¯
4. **è‡ªå®šç¾© Web ç•Œé¢**ï¼šä¿®æ”¹ `handleHome()` ä¸­çš„ HTML

### API æ“´å±•
ç¨‹å¼æä¾› REST APIï¼š
- `GET /api/slaves`ï¼šç²å–æ‰€æœ‰ Slaves ç‹€æ…‹
- `GET /api/data?port=X&type=Y&start=Z&count=W`ï¼šç²å–æŒ‡å®šæ•¸æ“š
